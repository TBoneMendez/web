<!-- Monthly data payloads for app.js -->
<script id="monthlyData" type="application/json">{{ monthly_json | safe }}</script>
<script id="monthlyByLoanData" type="application/json">{{ monthly_by_loan_json | safe }}</script>

<!-- KPI SECTION -->
<div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
  <div class="p-4 bg-white rounded-xl shadow"><div class="text-sm text-gray-500">Companies</div><div id="kpiCompanies" class="text-2xl font-semibold">{{ kpis.companies }}</div></div>
  <div class="p-4 bg-white rounded-xl shadow"><div class="text-sm text-gray-500">Loans</div><div id="kpiLoans" class="text-2xl font-semibold">{{ kpis.loans }}</div></div>
  <div class="p-4 bg-white rounded-xl shadow"><div class="text-sm text-gray-500">Invested</div><div id="kpiInvested" class="text-2xl font-semibold">{{ '%.0f' % kpis.invested }}</div></div>
  <div class="p-4 bg-white rounded-xl shadow"><div class="text-sm text-gray-500">Accum. interest</div><div id="kpiAccInt" class="text-2xl font-semibold">{{ '%.0f' % kpis.accumulated_interest }}</div></div>
  <div class="p-4 bg-white rounded-xl shadow"><div class="text-sm text-gray-500">Est. total interest</div><div id="kpiEstInt" class="text-2xl font-semibold">{{ '%.0f' % kpis.est_total_interest }}</div></div>
</div>

<!-- MONTHLY CHART -->
<div class="bg-white rounded-xl shadow p-4 mb-6">
  <div class="flex items-center justify-between mb-3">
    <div class="flex items-center gap-3">
      <h2 class="text-lg font-semibold">Monthly overview</h2>
      <span class="text-xs text-gray-400">NOK</span>
    </div>
    <div class="flex items-center gap-2 text-sm">
      <label class="text-gray-500">Metric:</label>
      <select id="metricSelect" class="border rounded px-2 py-1">
        <option value="interest">Interest</option>
        <option value="principal">Principal repaid</option>
      </select>
      <button id="thisYearBtn" class="border rounded px-2 py-1">This year</button>
      <button id="allDataBtn" class="border rounded px-2 py-1">All data</button>
    </div>
  </div>
  <div class="h-64"><canvas id="monthlyChart"></canvas></div>
</div>

<!-- COMPANY SUMMARY -->
<div class="bg-white rounded-xl shadow p-4 mb-6">
  <div class="flex items-center justify-between mb-2">
    <h2 class="text-lg font-semibold">By company</h2>
    <div class="flex items-center gap-2 text-sm">
      <span class="text-gray-500">Sort:</span>
      <select id="companySortKey" class="border rounded px-2 py-1">
        <option value="loans"># loans</option>
        <option value="invested">Invested</option>
        <option value="acc">Accum. interest</option>
        <option value="est">Est. total interest</option>
      </select>
      <select id="companySortDir" class="border rounded px-2 py-1">
        <option value="desc">Desc</option>
        <option value="asc">Asc</option>
      </select>
    </div>
  </div>
  <div class="overflow-auto">
    <table class="min-w-full text-sm">
      <thead>
        <tr class="text-left border-b">
          <th class="py-2 pr-4">Company</th>
          <th class="py-2 pr-4">Loans</th>
          <th class="py-2 pr-4">Active</th>
          <th class="py-2 pr-4">Repaid</th>
          <th class="py-2 pr-4">Invested</th>
          <th class="py-2 pr-4">Accum. interest</th>
          <th class="py-2 pr-4">Est. total interest</th>
        </tr>
      </thead>
      <tbody id="companyBody">
        {% for r in by_company %}
        <tr class="border-b last:border-0">
          <td class="py-1 pr-4">{{ r.Company }}</td>
          <td class="py-1 pr-4">{{ r.loans }}</td>
          <td class="py-1 pr-4">{{ r.active_loans }}</td>
          <td class="py-1 pr-4">{{ r.repaid_loans }}</td>
          <td class="py-1 pr-4">{{ '%.0f' % r.invested }}</td>
          <td class="py-1 pr-4">{{ '%.0f' % r.accumulated_interest }}</td>
          <td class="py-1 pr-4">{{ '%.0f' % r.estimated_total_interest }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- LOANS -->
<div class="flex items-center justify-between mb-2">
  <h2 class="text-lg font-semibold">Loans</h2>
  <div class="flex items-center gap-2 text-sm">
    <span class="text-gray-500">Sort:</span>
    <select id="loanSortKey" class="border rounded px-2 py-1">
      <option value="status">Loan status</option>
      <option value="returnpct">% return</option>
      <option value="invested">Invested</option>
      <option value="acc">Accum. interest</option>
      <option value="interest">Rate</option>
      <option value="duration">Duration</option>
      <option value="lastpay">Last payment</option>
    </select>
    <select id="loanSortDir" class="border rounded px-2 py-1">
      <option value="desc">Desc</option>
      <option value="asc">Asc</option>
    </select>
  </div>
</div>

<div id="loanGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
  {% for r in by_loan %}
  <div class="loan-card bg-white rounded-xl shadow p-4 border"
       data-company="{{ r.Company }}"
       data-loan="{{ r.loan_id }}"
       data-status="{{ r.status }}"
       data-invested="{{ '%.2f' % r.invested }}"
       data-interest="{{ '%.2f' % r.interest }}"
       data-duration="{{ r.duration }}"
       data-acc="{{ '%.2f' % r.accumulated_interest }}"
       data-est="{{ '%.2f' % r.estimated_total_interest }}"
       data-returnpct="{{ '%.2f' % r.interest_return_pct }}"
       data-lastpay="{{ r.last_payment_date }}"
       data-start="{{ r.start_date }}"
       data-end="{{ r.end_date }}">
    <div class="flex items-start justify-between mb-2">
      <div>
        <div class="text-sm text-gray-500">{{ r.Company }}</div>
        <div class="text-lg font-semibold">Loan #{{ r.loan_id }}</div>
      </div>
      <div class="text-right">
        {% if r.status == "repaid" %}
          <span class="status-badge bg-green-100 text-green-700 border-green-300">Repaid</span>
        {% elif r.status == "assigned" %}
          <span class="status-badge bg-blue-100 text-blue-700 border-blue-300">Assigned</span>
        {% else %}
          <span class="status-badge bg-yellow-100 text-yellow-700 border-yellow-300">Active</span>
        {% endif %}
        <div class="text-xs text-gray-500 mt-1">Rate</div>
        <div class="text-base font-medium">{{ '%.2f' % r.interest }}%</div>
      </div>
    </div>
    <div class="grid grid-cols-2 gap-2 text-sm">
      <div class="bg-gray-50 rounded p-2"><div class="text-xs text-gray-500">Duration</div><div class="font-medium">{{ r.duration }} m</div></div>
      <div class="bg-gray-50 rounded p-2"><div class="text-xs text-gray-500">Invested</div><div class="font-medium">{{ '%.0f' % r.invested }}</div></div>
      <div class="bg-gray-50 rounded p-2"><div class="text-xs text-gray-500">Accum. interest</div><div class="font-medium">{{ '%.0f' % r.accumulated_interest }}</div></div>
      <div class="bg-gray-50 rounded p-2"><div class="text-xs text-gray-500">Est. total interest</div><div class="font-medium">{{ '%.0f' % r.estimated_total_interest }}</div></div>
      <div class="bg-gray-50 rounded p-2"><div class="text-xs text-gray-500">% return</div><div class="font-medium">{{ '%.1f' % r.interest_return_pct }}%</div></div>
      <div class="bg-gray-50 rounded p-2">
        <div class="text-xs text-gray-500">Last payment</div>
        <div class="font-medium">
          {% if r.status != "assigned" and r.last_payment_date and r.last_payment_date != 'NaT' %}
            {{ r.last_payment_date }}
          {% endif %}
        </div>
      </div>
    </div>
    <div class="text-xs text-gray-500 mt-2">Period: {{ r.start_date }} â†’ {{ r.end_date }}</div>
  </div>
  {% endfor %}
</div>
